generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User & Authentication
model User {
  id            String    @id @default(cuid())
  username      String    @unique  // Login username (case-insensitive)
  email         String?   // Optional, used for password recovery via Google
  password      String    // Hashed with bcrypt (HIPAA compliant)
  firstName     String?
  lastName      String?
  name          String?   // Display name
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  isSuperuser   Boolean   @default(false)  // Full admin access
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  failedLoginAttempts Int @default(0)
  lockedUntil   DateTime?

  // Professional Credentials (for healthcare providers)
  isDoctor      Boolean   @default(false)
  deaNumber     String?   // DEA registration number
  npiNumber     String?   // National Provider Identifier
  licenseNumber String?   // Medical license number
  licenseType   String?   // MD, DO, NP, PA, etc.
  licenseState  String?   // State of licensure
  clinicName    String?

  // Pharmacy roles
  isPharmacist          Boolean @default(false)
  isPharmacyTechnician  Boolean @default(false)

  // AI settings
  aiProvider    String?   // 'openai' or 'gemini'
  openaiApiKey  String?
  geminiApiKey  String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  patients      Patient[]
  auditLogs     AuditLog[]
  pharmacyStaff PharmacyStaff?

  @@index([username])
  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
  DOCTOR
  NURSE
  PATIENT
}

// Healthcare Models
model Patient {
  id              String    @id @default(cuid())
  mrn             String    @unique // Medical Record Number
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          Gender
  email           String?
  phone           String?
  address         String?   @db.Text
  city            String?
  state           String?
  zipCode         String?
  country         String?

  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?

  // Insurance
  insuranceProvider     String?
  insurancePolicyNumber String?

  // Medical Information
  allergies             String?   @db.Text  // Comma-separated list of allergies
  medicalConditions     String?   @db.Text  // Comma-separated list of conditions

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?

  user            User?     @relation(fields: [createdBy], references: [id])
  encounters      Encounter[]
  fhirResources   FhirResource[]
  observations    Observation[]
  medications     Medication[]
  conditions      Condition[]

  // Pharmacy Relations
  prescriptionIntakes   PrescriptionIntake[]
  pdmpQueries           PDMPQuery[]
  signatureRecords      SignatureRecord[]
  immunizationRecords   ImmunizationRecord[]
  willCallBins          WillCallBin[]
  prescriptionTransfers PrescriptionTransfer[]

  // Dispensing Workflow Relations
  prescriptions         Prescription[]
  pickupSessions        PickupSession[]

  @@index([mrn])
  @@index([lastName, firstName])
  @@index([createdBy])
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

model Encounter {
  id              String    @id @default(cuid())
  patientId       String
  type            EncounterType
  status          EncounterStatus
  startDate       DateTime
  endDate         DateTime?
  reason          String?   @db.Text
  notes           String?   @db.Text
  diagnosis       String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patient         Patient   @relation(fields: [patientId], references: [id])
  observations    Observation[]
  medications     Medication[]

  @@index([patientId])
  @@index([startDate])
}

enum EncounterType {
  OUTPATIENT
  INPATIENT
  EMERGENCY
  TELEHEALTH
  HOME_HEALTH
}

enum EncounterStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Observation {
  id              String    @id @default(cuid())
  patientId       String
  encounterId     String?
  code            String    // LOINC code
  codeSystem      String    @default("http://loinc.org")
  display         String
  value           String?
  unit            String?
  interpretation  String?
  status          ObservationStatus @default(FINAL)
  effectiveDate   DateTime

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patient         Patient   @relation(fields: [patientId], references: [id])
  encounter       Encounter? @relation(fields: [encounterId], references: [id])

  @@index([patientId])
  @@index([encounterId])
  @@index([code])
}

enum ObservationStatus {
  REGISTERED
  PRELIMINARY
  FINAL
  AMENDED
  CANCELLED
}

model Medication {
  id              String    @id @default(cuid())
  patientId       String
  encounterId     String?
  rxnormCode      String?   // RxNorm code
  ndcCode         String?   // NDC code
  name            String
  dosage          String?
  frequency       String?
  route           String?
  status          MedicationStatus @default(ACTIVE)
  startDate       DateTime
  endDate         DateTime?
  prescribedBy    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patient         Patient   @relation(fields: [patientId], references: [id])
  encounter       Encounter? @relation(fields: [encounterId], references: [id])

  @@index([patientId])
  @@index([rxnormCode])
}

enum MedicationStatus {
  ACTIVE
  COMPLETED
  STOPPED
  ON_HOLD
}

// Patient Conditions (FHIR Condition Resource)
model Condition {
  id              String    @id @default(cuid())
  patientId       String
  encounterId     String?
  code            String?   // SNOMED CT or ICD-10 code
  codeSystem      String?   // e.g., "SNOMED CT", "ICD-10"
  name            String    // Condition/diagnosis name
  status          ConditionStatus @default(ACTIVE)
  severity        String?   // mild, moderate, severe
  onsetDate       DateTime?
  abatementDate   DateTime?
  recordedDate    DateTime  @default(now())
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patient         Patient   @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([code])
  @@index([status])
}

enum ConditionStatus {
  ACTIVE
  RECURRENCE
  RELAPSE
  INACTIVE
  REMISSION
  RESOLVED
}

// FHIR Resource Storage
model FhirResource {
  id              String    @id @default(cuid())
  resourceType    String
  resourceId      String
  patientId       String?
  data            Json
  version         Int       @default(1)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patient         Patient?  @relation(fields: [patientId], references: [id])

  @@unique([resourceType, resourceId])
  @@index([patientId])
  @@index([resourceType])
}

// Audit Logging for HIPAA Compliance
model AuditLog {
  id              String    @id @default(cuid())
  userId          String?
  action          AuditAction
  resourceType    String
  resourceId      String?
  details         Json?
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime  @default(now())

  user            User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceType])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  PRINT
  // Authentication audit actions
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGIN_BLOCKED
  REGISTER_SUCCESS
  REGISTER_FAILED
  REGISTER_ERROR
  REGISTER_RATE_LIMITED
  // PHI access audit actions (HIPAA compliance)
  PHI_VIEW
  PHI_CREATE
  PHI_UPDATE
  PHI_DELETE
  PHI_EXPORT
  // Pharmacy audit actions
  PRESCRIPTION_INTAKE
  PRESCRIPTION_FILL
  PRESCRIPTION_VERIFY
  PRESCRIPTION_DISPENSE
  CONTROLLED_SUBSTANCE_DISPENSE
  PDMP_QUERY
  SIGNATURE_CAPTURE
  IMMUNIZATION_ADMIN
}

// ============================================================================
// PHARMACY MANAGEMENT MODELS (MedsCab)
// ============================================================================

// Pharmacy Staff with Role-Based Access Control
model PharmacyStaff {
  id                  String    @id @default(cuid())
  userId              String    @unique
  role                PharmacyRole
  permissionLevel     Int       @default(10)  // 0 = highest (master), 10 = lowest (cashier)

  // Professional Credentials
  licenseNumber       String?
  licenseState        String?
  licenseExpiration   DateTime?
  deaNumber           String?
  deaSuffix           String?   // For mid-level practitioners
  npiNumber           String?

  // Certifications
  immunizationCertified       Boolean   @default(false)
  immunizationCertExpiration  DateTime?
  controlledSubstanceCertified Boolean  @default(false)
  mtmCertified                Boolean   @default(false)
  compoundingCertified        Boolean   @default(false)

  // Supervision (for techs and interns)
  supervisorId        String?
  canSupervise        Boolean   @default(false)
  maxTechsSupervised  Int       @default(0)

  // Work Schedule
  schedulePattern     String?   // JSON string of schedule
  hireDate            DateTime?
  terminationDate     DateTime?

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user                User      @relation(fields: [userId], references: [id])
  supervisor          PharmacyStaff? @relation("Supervision", fields: [supervisorId], references: [id])
  supervisees         PharmacyStaff[] @relation("Supervision")
  intakeRecords       PrescriptionIntake[] @relation("IntakeBy")
  verifiedIntakes     PrescriptionIntake[] @relation("VerifiedBy")
  pdmpQueries         PDMPQuery[]
  signaturesWitnessed SignatureRecord[]
  immunizationsGiven  ImmunizationRecord[]

  // Dispensing Workflow Relations
  assignedPrescriptions Prescription[] @relation("AssignedPrescriptions")
  fillsEntered        PrescriptionFill[] @relation("FillsEntered")
  fillsFilled         PrescriptionFill[] @relation("FillsFilled")
  fillsVerified       PrescriptionFill[] @relation("FillsVerified")
  fillsSold           PrescriptionFill[] @relation("FillsSold")
  notesCreated        PrescriptionNote[] @relation("NotesCreated")
  stateChanges        PrescriptionStateHistory[] @relation("StateChanges")
  durOverrides        PrescriptionDURAlert[] @relation("DUROverrides")
  durAcknowledged     PrescriptionDURAlert[] @relation("DURAcknowledged")
  pickupsStarted      PickupSession[] @relation("PickupsStarted")
  pickupsCompleted    PickupSession[] @relation("PickupsCompleted")

  @@index([userId])
  @@index([role])
  @@index([supervisorId])
}

enum PharmacyRole {
  MASTER_USER           // Level 0 - Full system access
  SYSTEM_ADMIN          // Level 1 - IT administration
  COMPUTER_TECH         // Level 2 - Technical support
  PHARMACY_MANAGER      // Level 3 - Store operations
  PHARMACIST            // Level 4 - Licensed pharmacist (PIC)
  STAFF_PHARMACIST      // Level 5 - Staff pharmacist
  PHARMACY_INTERN       // Level 6 - Pharmacy intern
  PHARMACY_TECH_LEAD    // Level 7 - Senior tech
  PHARMACY_TECH         // Level 8 - Certified tech
  TECH_IN_TRAINING      // Level 9 - Tech trainee
  CASHIER               // Level 10 - Front register
  DELIVERY_DRIVER       // Level 10 - Delivery only
}

// Prescription Intake Records
model PrescriptionIntake {
  id                  String    @id @default(cuid())

  // Source Information
  channel             IntakeChannel
  sourceIdentifier    String?   // Fax number, e-Rx ID, transfer pharmacy

  // Patient Information
  patientId           String?
  patientFirstName    String
  patientLastName     String
  patientDOB          DateTime
  patientPhone        String?
  patientAddress      String?   @db.Text

  // Prescriber Information
  prescriberName      String
  prescriberNPI       String?
  prescriberDEA       String?
  prescriberPhone     String?
  prescriberFax       String?
  prescriberAddress   String?   @db.Text

  // Prescription Details
  drugName            String
  drugNDC             String?
  quantity            Int
  daysSupply          Int?
  refillsAuthorized   Int       @default(0)
  directions          String    @db.Text
  dawCode             Int       @default(0)  // Dispense As Written

  // Controlled Substance Info
  isControlled        Boolean   @default(false)
  schedule            Int?      // DEA schedule 2-5
  epcsSignature       String?   @db.Text  // Electronic prescribing signature

  // AI/OCR Processing
  ocrConfidence       Float?
  aiInterpretation    Json?     // AI-processed data
  requiresReview      Boolean   @default(false)

  // Status
  status              IntakeStatus @default(PENDING)
  rejectionReason     String?

  // Staff
  intakeById          String?
  verifiedById        String?
  intakeAt            DateTime  @default(now())
  verifiedAt          DateTime?

  // Original Document
  originalDocument    String?   @db.Text  // Base64 or file path

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  patient             Patient?  @relation(fields: [patientId], references: [id])
  intakeBy            PharmacyStaff? @relation("IntakeBy", fields: [intakeById], references: [id])
  verifiedBy          PharmacyStaff? @relation("VerifiedBy", fields: [verifiedById], references: [id])

  @@index([patientId])
  @@index([status])
  @@index([channel])
  @@index([intakeAt])
}

enum IntakeChannel {
  E_PRESCRIBE         // Surescripts
  FAX                 // eFax/traditional fax
  PHONE               // Phone-in
  HARD_COPY           // Written prescription
  TRANSFER_IN         // Transfer from another pharmacy
  REFILL_REQUEST      // Patient refill request
  EMR_INTEGRATION     // Direct EMR integration
}

enum IntakeStatus {
  PENDING             // Awaiting processing
  IN_REVIEW           // Under pharmacist review
  CLARIFICATION_NEEDED // Needs prescriber contact
  APPROVED            // Ready for filling
  REJECTED            // Rejected/invalid
  TRANSFERRED         // Transferred to workflow
}

// PDMP Query Records
model PDMPQuery {
  id                  String    @id @default(cuid())
  patientId           String

  // Query Details
  queryType           PDMPQueryType
  statesQueried       String    // Comma-separated state codes

  // Results
  querySuccessful     Boolean
  prescriptionsFound  Int       @default(0)
  results             Json?     // Full PDMP results

  // Risk Analysis
  riskScore           Int?      // 0-100
  mmeDaily            Float?    // Morphine Milligram Equivalent
  alerts              Json?     // Array of alerts

  // Flags
  hasMultiplePrescriberAlert  Boolean @default(false)
  hasMultiplePharmacyAlert    Boolean @default(false)
  hasOverlappingRxAlert       Boolean @default(false)
  hasHighMMEAlert             Boolean @default(false)
  hasEarlyRefillAlert         Boolean @default(false)

  // Staff
  queriedById         String
  queriedAt           DateTime  @default(now())

  // Response
  responseTime        Int?      // Milliseconds
  errorMessage        String?

  patient             Patient   @relation(fields: [patientId], references: [id])
  queriedBy           PharmacyStaff @relation(fields: [queriedById], references: [id])

  @@index([patientId])
  @@index([queriedAt])
  @@index([riskScore])
}

enum PDMPQueryType {
  STANDARD            // Normal query
  EMERGENCY           // Emergency dispense
  OPIOID_NAIVE        // First-time opioid patient
  HIGH_RISK           // Known high-risk patient
  AUDIT               // Audit/compliance check
}

// Signature Records (HIPAA/21 CFR Part 11 Compliant)
model SignatureRecord {
  id                  String    @id @default(cuid())
  patientId           String

  // Signature Data
  signatureType       SignatureType
  signatureData       String    @db.LongText  // Base64 encoded image
  signatureHash       String    // SHA-256 hash for integrity

  // Capture Details
  captureDevice       String?   // Device type (Topaz, ePadLink, etc.)
  captureTimestamp    DateTime
  captureLocation     String?   // Terminal/station ID

  // Verification
  idVerificationType  IDVerificationType?
  idVerificationData  Json?     // ID details (masked)

  // Consent/Purpose
  purpose             String    // HIPAA consent, pickup, counseling waiver
  documentSigned      String?   // Reference to document

  // Witnessing
  witnessedById       String?
  witnessTimestamp    DateTime?

  // Validity
  validUntil          DateTime  // 6 months per HIPAA
  isRevoked           Boolean   @default(false)
  revokedAt           DateTime?
  revokedReason       String?

  createdAt           DateTime  @default(now())

  patient             Patient   @relation(fields: [patientId], references: [id])
  witnessedBy         PharmacyStaff? @relation(fields: [witnessedById], references: [id])

  @@index([patientId])
  @@index([signatureType])
  @@index([validUntil])
}

enum SignatureType {
  HIPAA_CONSENT
  PRESCRIPTION_PICKUP
  COUNSELING_ACCEPTANCE
  COUNSELING_WAIVER
  CONTROLLED_SUBSTANCE
  ID_VERIFICATION
  DELIVERY_RECEIPT
  IMMUNIZATION_CONSENT
}

enum IDVerificationType {
  DRIVERS_LICENSE
  STATE_ID
  PASSPORT
  MILITARY_ID
  TRIBAL_ID
  PATIENT_PHOTO
  BIOMETRIC
}

// Vaccine Inventory
model VaccineInventory {
  id                  String    @id @default(cuid())

  // Vaccine Identification
  cvxCode             String    // CDC CVX code
  mvxCode             String?   // CDC MVX (manufacturer) code
  ndcCode             String
  vaccineName         String
  manufacturer        String

  // Lot Information
  lotNumber           String
  expirationDate      DateTime

  // Quantity
  quantityOnHand      Int
  quantityAllocated   Int       @default(0)  // Reserved for appointments
  dosesPerVial        Int       @default(1)

  // Storage
  storageUnitId       String?
  storageRequirement  StorageRequirement

  // VFC (Vaccines for Children)
  isVfcStock          Boolean   @default(false)
  vfcPinNumber        String?

  // Funding Source
  fundingSource       VaccineFundingSource @default(PRIVATE)

  // Tracking
  receivedDate        DateTime
  receivedFrom        String?   // Distributor/CDC
  poNumber            String?
  unitCost            Float?

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  storageUnit         VaccineStorageUnit? @relation(fields: [storageUnitId], references: [id])
  immunizations       ImmunizationRecord[]

  @@index([cvxCode])
  @@index([lotNumber])
  @@index([expirationDate])
  @@index([storageUnitId])
}

enum StorageRequirement {
  REFRIGERATED        // 2-8°C (35-46°F)
  FROZEN              // -50 to -15°C (-58 to 5°F)
  ULTRA_COLD          // -90 to -60°C (-130 to -76°F)
  ROOM_TEMP           // 20-25°C (68-77°F)
}

enum VaccineFundingSource {
  PRIVATE             // Private insurance/patient pay
  VFC                 // Vaccines for Children
  STATE_SUPPLIED      // State program
  FEDERAL_317         // Section 317 federal program
  OTHER_PUBLIC        // Other public funding
}

// Immunization Administration Records
model ImmunizationRecord {
  id                  String    @id @default(cuid())
  patientId           String
  vaccineInventoryId  String

  // Administration Details
  administrationDate  DateTime
  administrationSite  String    // Left deltoid, right thigh, etc.
  administrationRoute String    // IM, SC, ID, PO
  doseNumber          Int?      // Dose in series

  // VIS (Vaccine Information Statement)
  visPublicationDate  DateTime?
  visGivenDate        DateTime

  // Administered By
  administeredById    String
  supervisorId        String?   // If administered by intern/tech

  // Standing Order
  standingOrderId     String?
  standingOrderUsed   Boolean   @default(false)

  // Screening
  screeningCompleted  Boolean   @default(true)
  screeningQuestions  Json?     // Screening responses

  // Adverse Events
  hasAdverseEvent     Boolean   @default(false)
  adverseEventDetails String?   @db.Text
  vaersReported       Boolean   @default(false)
  vaersReportId       String?

  // IIS Reporting
  iisReported         Boolean   @default(false)
  iisReportedAt       DateTime?
  iisMessageId        String?
  iisAckStatus        String?

  // Billing
  cptCode             String?
  billedAmount        Float?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  patient             Patient   @relation(fields: [patientId], references: [id])
  vaccineInventory    VaccineInventory @relation(fields: [vaccineInventoryId], references: [id])
  administeredBy      PharmacyStaff @relation(fields: [administeredById], references: [id])
  standingOrder       StandingOrder? @relation(fields: [standingOrderId], references: [id])

  @@index([patientId])
  @@index([administrationDate])
  @@index([vaccineInventoryId])
  @@index([administeredById])
}

// Standing Orders for Immunizations
model StandingOrder {
  id                  String    @id @default(cuid())

  // Order Details
  name                String
  vaccineTypes        String    // Comma-separated CVX codes
  description         String    @db.Text

  // Protocol
  protocolUrl         String?   // Link to protocol document
  protocolVersion     String?

  // Authorizing Prescriber
  prescriberName      String
  prescriberNPI       String
  prescriberLicense   String

  // Eligibility Criteria
  minAge              Int?      // Minimum age in months
  maxAge              Int?      // Maximum age in months
  genderRestriction   Gender?
  conditions          String?   @db.Text  // Required/excluded conditions

  // Validity
  effectiveDate       DateTime
  expirationDate      DateTime

  // State/Jurisdiction
  stateCode           String    // Two-letter state code

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  immunizations       ImmunizationRecord[]

  @@index([stateCode])
  @@index([effectiveDate])
  @@index([expirationDate])
}

// Vaccine Storage Unit (Temperature Monitoring)
model VaccineStorageUnit {
  id                  String    @id @default(cuid())

  // Unit Details
  name                String
  unitType            StorageUnitType
  location            String?
  serialNumber        String?

  // Temperature Settings
  storageRequirement  StorageRequirement
  minTempCelsius      Float
  maxTempCelsius      Float
  currentTempCelsius  Float?
  lastTempReadingAt   DateTime?

  // Monitoring
  monitoringDeviceId  String?
  monitoringProvider  String?   // Temperature monitoring service
  alertsEnabled       Boolean   @default(true)
  alertEmail          String?
  alertPhone          String?

  // Excursion Tracking
  hasActiveExcursion  Boolean   @default(false)
  lastExcursionAt     DateTime?
  excursionCount      Int       @default(0)

  // Capacity
  maxCapacityDoses    Int?
  currentDoses        Int       @default(0)

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  vaccines            VaccineInventory[]
  temperatureLogs     TemperatureLog[]

  @@index([storageRequirement])
  @@index([hasActiveExcursion])
}

enum StorageUnitType {
  REFRIGERATOR
  FREEZER
  ULTRA_COLD_FREEZER
  COMBINATION_UNIT
  PORTABLE_COOLER
}

// Temperature Log for CDC Compliance
model TemperatureLog {
  id                  String    @id @default(cuid())
  storageUnitId       String

  // Reading
  temperatureCelsius  Float
  recordedAt          DateTime
  recordedBy          String?   // Staff ID or "AUTOMATED"

  // Status
  isWithinRange       Boolean
  isExcursion         Boolean   @default(false)
  excursionMinutes    Int?

  // Actions Taken (if excursion)
  actionsTaken        String?   @db.Text

  createdAt           DateTime  @default(now())

  storageUnit         VaccineStorageUnit @relation(fields: [storageUnitId], references: [id])

  @@index([storageUnitId])
  @@index([recordedAt])
  @@index([isExcursion])
}

// Will-Call Bin Management
model WillCallBin {
  id                  String    @id @default(cuid())

  // Bin Location
  binNumber           String    @unique
  location            String?   // Aisle, shelf, etc.

  // Patient Assignment
  patientId           String?
  patientLastName     String?

  // Contents
  prescriptionCount   Int       @default(0)

  // Timing
  firstFilledAt       DateTime?
  lastActivityAt      DateTime?

  // Auto-Reverse Settings
  daysUntilReverse    Int       @default(10)
  scheduledReverseAt  DateTime?

  // Status
  status              WillCallStatus @default(EMPTY)

  // Notifications
  notificationsSent   Int       @default(0)
  lastNotificationAt  DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  patient             Patient?  @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([binNumber])
  @@index([status])
  @@index([scheduledReverseAt])
}

enum WillCallStatus {
  EMPTY
  ASSIGNED
  READY_FOR_PICKUP
  PARTIAL_PICKUP
  AWAITING_PAYMENT
  SCHEDULED_REVERSE
}

// Prescription Transfer Records
model PrescriptionTransfer {
  id                  String    @id @default(cuid())

  // Original Prescription
  originalRxNumber    String
  medicationName      String
  medicationNDC       String?
  quantity            Int
  refillsRemaining    Int

  // Patient
  patientId           String
  patientFirstName    String
  patientLastName     String
  patientDOB          DateTime

  // Transfer Direction
  direction           TransferDirection

  // Other Pharmacy
  otherPharmacyName   String
  otherPharmacyPhone  String
  otherPharmacyNPI    String?
  otherPharmacyAddress String? @db.Text

  // Original Prescriber
  prescriberName      String
  prescriberNPI       String?
  prescriberDEA       String?
  prescriberPhone     String?

  // Transfer Staff
  ourPharmacistId     String
  ourPharmacistName   String
  theirPharmacistName String?

  // Transfer Details
  transferredAt       DateTime
  originalWrittenDate DateTime
  originalFillDate    DateTime?
  lastFillDate        DateTime?
  totalFillsUsed      Int       @default(0)

  // Controlled Substance
  isControlled        Boolean   @default(false)
  schedule            Int?

  // Status
  status              TransferStatus @default(COMPLETED)
  notes               String?   @db.Text

  createdAt           DateTime  @default(now())

  patient             Patient   @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([direction])
  @@index([transferredAt])
}

enum TransferDirection {
  TRANSFER_IN
  TRANSFER_OUT
}

enum TransferStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REJECTED
}

// ============================================================================
// RETAIL PHARMACY DISPENSING WORKFLOW MODELS
// ============================================================================

// Prescription Workflow State Machine (15 states)
enum PrescriptionWorkflowState {
  INTAKE                // Just received (e-Rx, fax, phone, walk-in)
  DATA_ENTRY            // Being entered/verified by technician
  DATA_ENTRY_COMPLETE   // Data entry finished, awaiting insurance
  INSURANCE_PENDING     // Awaiting insurance adjudication
  INSURANCE_REJECTED    // Insurance rejected, needs resolution
  DUR_REVIEW            // DUR alerts need pharmacist review
  PRIOR_AUTH_PENDING    // Prior authorization submitted
  PRIOR_AUTH_APPROVED   // PA approved, ready to proceed
  FILLING               // Being filled by technician
  VERIFICATION          // Awaiting pharmacist verification
  READY                 // Ready for pickup/delivery
  SOLD                  // Picked up by patient
  DELIVERED             // Delivered to patient
  RETURNED_TO_STOCK     // Returned to stock (not picked up)
  CANCELLED             // Cancelled
}

enum WorkflowPriority {
  STAT                  // Emergency - immediate
  URGENT                // Priority processing
  NORMAL                // Standard processing
  LOW                   // Can wait
}

enum ClaimTransactionType {
  B1                    // Original billing
  B2                    // Reversal
  B3                    // Rebill
  E1                    // Eligibility verification
}

enum ClaimStatusType {
  PENDING               // Not yet submitted
  SUBMITTED             // Sent to PBM
  APPROVED              // Paid/approved
  REJECTED              // Rejected by PBM
  PAID                  // Payment received
  REVERSED              // Claim reversed
  APPEALING             // Under appeal
}

enum PrescriptionNoteType {
  GENERAL               // General notes
  CLINICAL              // Clinical information
  INSURANCE             // Insurance-related
  PATIENT_REQUEST       // Patient communication
  PRESCRIBER_COMM       // Prescriber communication
  DUR_OVERRIDE          // DUR override documentation
  WORKFLOW              // System workflow notes
}

enum PickupSessionType {
  RETAIL                // In-store pickup
  DRIVE_THRU            // Drive-through window
  DELIVERY              // Home delivery
  CURBSIDE              // Curbside pickup
  MAIL                  // Mail order
}

enum PickupSessionStatus {
  IN_PROGRESS           // Active session
  COMPLETED             // Pickup completed
  CANCELLED             // Session cancelled
  PARTIAL               // Partial pickup
}

enum DAWCode {
  DAW_0                 // No product selection indicated
  DAW_1                 // Substitution not allowed by prescriber
  DAW_2                 // Substitution allowed - patient requested product
  DAW_3                 // Substitution allowed - pharmacist selected
  DAW_4                 // Substitution allowed - generic not in stock
  DAW_5                 // Substitution allowed - brand dispensed as generic
  DAW_6                 // Override
  DAW_7                 // Substitution not allowed - brand mandated by law
  DAW_8                 // Substitution allowed - generic not available
  DAW_9                 // Other
}

// Prescriber (Provider) Information
model Prescriber {
  id                  String    @id @default(cuid())

  // Identification
  npiNumber           String    @unique
  deaNumber           String?   // DEA registration
  deaSuffix           String?   // For mid-level practitioners
  stateLicense        String?
  licenseState        String?

  // Personal Info
  firstName           String
  lastName            String
  middleName          String?
  suffix              String?   // MD, DO, NP, PA, etc.
  specialty           String?

  // Contact Info
  phone               String?
  fax                 String?
  email               String?

  // Address
  addressLine1        String?
  addressLine2        String?
  city                String?
  state               String?
  zipCode             String?

  // Practice Info
  practiceName        String?
  practiceNpi         String?

  // Verification Status
  isVerified          Boolean   @default(false)
  verifiedAt          DateTime?
  verifiedMethod      String?   // NPPES, state board, manual

  // DEA Specifics
  canPrescribeCII     Boolean   @default(false)
  canPrescribeCIII_V  Boolean   @default(false)
  deaExpiration       DateTime?

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  prescriptions       Prescription[]

  @@index([npiNumber])
  @@index([deaNumber])
  @@index([lastName, firstName])
}

// Drug Reference (Medication Master)
model Drug {
  id                  String    @id @default(cuid())

  // NDC Identification
  ndc                 String    @unique  // 11-digit normalized
  ndc54               String?   // 5-4-2 formatted

  // Drug Names
  brandName           String
  genericName         String
  displayName         String    // Primary display name

  // Strength & Form
  strength            String
  strengthUnit        String?
  dosageForm          String
  route               String?

  // Classification
  deaSchedule         Int?      // 2-5 for controlled, null for non-controlled
  drugClass           String?
  therapeuticClass    String?

  // Packaging
  packageSize         Float?
  packageUnit         String?
  packageDescription  String?

  // Identifiers
  rxcui               String?   // RxNorm CUI
  gpi                 String?   // Generic Product Identifier
  gcn                 String?   // Generic Code Number

  // Manufacturer
  labelerName         String?
  labelerCode         String?   // First 5 digits of NDC

  // Pricing (AWP, WAC)
  awpPrice            Float?
  awpPackagePrice     Float?
  wacPrice            Float?

  // Dispensing
  defaultDaysSupply   Int?
  defaultQuantity     Float?
  tallManName         String?   // Tall Man lettering for LASA drugs

  // Flags
  isUnitDose          Boolean   @default(false)
  requiresFridge      Boolean   @default(false)
  isHazardous         Boolean   @default(false)
  isBrandOnly         Boolean   @default(false)
  isNarrowTherapeutic Boolean   @default(false)
  isHighAlert         Boolean   @default(false)

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  inventory           DrugInventory[]
  prescriptions       Prescription[]
  prescriptionFills   PrescriptionFill[]

  @@index([ndc])
  @@index([genericName])
  @@index([brandName])
  @@index([rxcui])
}

// Drug Inventory (NDC-level with lot tracking)
model DrugInventory {
  id                  String    @id @default(cuid())
  drugId              String

  // Lot Information
  lotNumber           String
  expirationDate      DateTime

  // Quantity
  quantityOnHand      Int       @default(0)
  quantityAllocated   Int       @default(0)  // Reserved for pending fills
  quantityAvailable   Int       @default(0)  // onHand - allocated

  // Purchasing
  acquisitionCost     Float?
  wholesalerId        String?
  poNumber            String?
  receivedDate        DateTime?

  // Location
  shelfLocation       String?
  binNumber           String?

  // Flags
  isRefrigerated      Boolean   @default(false)
  isQuarantined       Boolean   @default(false)
  quarantineReason    String?

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  drug                Drug      @relation(fields: [drugId], references: [id])
  prescriptionFills   PrescriptionFill[]

  @@unique([drugId, lotNumber])
  @@index([drugId])
  @@index([expirationDate])
  @@index([lotNumber])
}

// Insurance Plan
model InsurancePlan {
  id                  String    @id @default(cuid())

  // Plan Identification
  bin                 String    // 6-digit BIN
  pcn                 String    // Processor Control Number
  groupNumber         String?
  planName            String?

  // PBM Info
  pbmName             String?
  pbmPhone            String?
  helpDeskPhone       String?
  priorAuthPhone      String?
  priorAuthFax        String?

  // Plan Details
  planType            String?   // Commercial, Medicare D, Medicaid, etc.
  formularyId         String?

  // Copay Structure (defaults)
  copayGeneric        Float?
  copayBrandPref      Float?
  copayBrandNonPref   Float?
  copaySpecialty      Float?

  // Limits
  maxDaysSupply       Int?
  maxRefills          Int?

  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  claimTransactions   ClaimTransaction[]
  prescriptions       Prescription[]

  @@unique([bin, pcn, groupNumber])
  @@index([bin])
  @@index([pcn])
}

// Core Prescription (Workflow Entity)
model Prescription {
  id                  String    @id @default(cuid())
  rxNumber            String    @unique  // Unique Rx number

  // Patient
  patientId           String

  // Prescriber
  prescriberId        String

  // Drug Info
  drugId              String?   // Link to Drug master
  drugName            String    // Prescribed drug name
  drugNdc             String?   // Prescribed NDC
  strength            String?
  dosageForm          String?

  // Prescription Details
  quantityWritten     Int
  quantityRemaining   Int       // For partial fills
  daysSupply          Int
  directions          String    @db.Text  // SIG
  dawCode             DAWCode   @default(DAW_0)
  refillsAuthorized   Int       @default(0)
  refillsRemaining    Int       @default(0)

  // Controlled Substance
  isControlled        Boolean   @default(false)
  deaSchedule         Int?      // 2, 3, 4, 5

  // Dates
  writtenDate         DateTime
  effectiveDate       DateTime  @default(now())
  expirationDate      DateTime
  lastFilledDate      DateTime?

  // Origin
  intakeChannel       IntakeChannel?
  intakeId            String?   // Link to PrescriptionIntake
  eRxMessageId        String?   // Surescripts message ID

  // Workflow State
  workflowState       PrescriptionWorkflowState @default(INTAKE)
  priority            WorkflowPriority @default(NORMAL)
  promiseTime         DateTime?
  assignedToId        String?   // Staff member working on it

  // Insurance
  insurancePlanId     String?
  priorAuthNumber     String?
  priorAuthStatus     String?

  // Flags
  requiresCounseling  Boolean   @default(true)
  requiresIdCheck     Boolean   @default(false)
  isOnHold            Boolean   @default(false)
  holdReason          String?

  // EPCS (Electronic Prescribing for Controlled Substances)
  epcsSignature       String?   @db.Text
  epcsTimestamp       DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  patient             Patient   @relation(fields: [patientId], references: [id])
  prescriber          Prescriber @relation(fields: [prescriberId], references: [id])
  drug                Drug?     @relation(fields: [drugId], references: [id])
  insurancePlan       InsurancePlan? @relation(fields: [insurancePlanId], references: [id])
  assignedTo          PharmacyStaff? @relation("AssignedPrescriptions", fields: [assignedToId], references: [id])

  fills               PrescriptionFill[]
  claims              ClaimTransaction[]
  notes               PrescriptionNote[]
  stateHistory        PrescriptionStateHistory[]
  durAlerts           PrescriptionDURAlert[]

  @@index([rxNumber])
  @@index([patientId])
  @@index([prescriberId])
  @@index([workflowState])
  @@index([priority])
  @@index([promiseTime])
  @@index([createdAt])
}

// Prescription Fill Record (one per fill/refill)
model PrescriptionFill {
  id                  String    @id @default(cuid())
  prescriptionId      String
  fillNumber          Int       // 0 = original, 1+ = refills

  // Drug Dispensed (may differ from prescribed for generics)
  drugId              String?
  inventoryId         String?
  dispensedNdc        String
  dispensedDrugName   String

  // Quantities
  quantityDispensed   Int
  daysSupply          Int
  isPartialFill       Boolean   @default(false)
  partialFillReason   String?

  // Lot/Expiration
  lotNumber           String?
  expirationDate      DateTime?

  // Pricing
  acquisitionCost     Float     @default(0)
  dispensingFee       Float     @default(0)
  grossPrice          Float     @default(0)
  insurancePaid       Float     @default(0)
  patientPaid         Float     @default(0)
  copayAmount         Float     @default(0)

  // Labels
  labelsPrinted       Int       @default(0)
  auxiliaryLabels     String?   // Comma-separated codes

  // Personnel
  enteredById         String?
  filledById          String?
  verifiedById        String?
  soldById            String?

  // Timestamps
  enteredAt           DateTime  @default(now())
  filledAt            DateTime?
  verifiedAt          DateTime?
  soldAt              DateTime?

  // Status
  status              String    @default("pending")  // pending, filling, filled, verified, ready, sold, returned
  verificationStatus  String    @default("pending")  // pending, in_review, approved, rejected

  // Packaging
  packagingType       String    @default("vial")

  // Delivery
  willCallBinId       String?
  deliveryMethod      String    @default("pickup")

  // Verification Checklist (JSON)
  verificationData    Json?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  prescription        Prescription @relation(fields: [prescriptionId], references: [id])
  drug                Drug?     @relation(fields: [drugId], references: [id])
  inventory           DrugInventory? @relation(fields: [inventoryId], references: [id])
  enteredBy           PharmacyStaff? @relation("FillsEntered", fields: [enteredById], references: [id])
  filledBy            PharmacyStaff? @relation("FillsFilled", fields: [filledById], references: [id])
  verifiedBy          PharmacyStaff? @relation("FillsVerified", fields: [verifiedById], references: [id])
  soldBy              PharmacyStaff? @relation("FillsSold", fields: [soldById], references: [id])
  claimTransaction    ClaimTransaction?
  pickupSession       PickupSession? @relation(fields: [pickupSessionId], references: [id])
  pickupSessionId     String?

  @@unique([prescriptionId, fillNumber])
  @@index([prescriptionId])
  @@index([status])
  @@index([filledAt])
  @@index([verifiedAt])
}

// Claim Transaction (NCPDP)
model ClaimTransaction {
  id                  String    @id @default(cuid())
  prescriptionId      String
  fillId              String?   @unique

  // Transaction Info
  transactionType     ClaimTransactionType
  transactionId       String?   // PBM transaction reference

  // Insurance
  insurancePlanId     String?
  bin                 String
  pcn                 String
  groupNumber         String?
  memberId            String
  personCode          String    @default("01")

  // Claim Details
  ndc                 String
  quantity            Float
  daysSupply          Int
  dawCode             Int       @default(0)

  // Submitted Pricing
  ingredientCostSubmitted   Float
  dispensingFeeSubmitted    Float
  grossAmountSubmitted      Float
  usualAndCustomary         Float

  // Response Pricing
  ingredientCostPaid  Float?
  dispensingFeePaid   Float?
  totalAmountPaid     Float?
  patientPayAmount    Float?
  copayAmount         Float?
  coinsuranceAmount   Float?
  deductibleAmount    Float?

  // Status
  status              ClaimStatusType @default(PENDING)
  responseCode        String?   // A=Approved, R=Rejected, P=Paid
  authorizationNumber String?

  // Reject Info
  rejectCodes         String?   // Comma-separated reject codes
  rejectMessages      String?   @db.Text

  // DUR Response
  durResponseData     Json?

  // Prior Auth
  priorAuthNumber     String?
  priorAuthRequired   Boolean   @default(false)

  // Submission Clarification
  submissionClarificationCode String?  // SCC for 340B, etc.

  // Timestamps
  submittedAt         DateTime?
  respondedAt         DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  prescription        Prescription @relation(fields: [prescriptionId], references: [id])
  fill                PrescriptionFill? @relation(fields: [fillId], references: [id])
  insurancePlan       InsurancePlan? @relation(fields: [insurancePlanId], references: [id])

  @@index([prescriptionId])
  @@index([status])
  @@index([submittedAt])
  @@index([transactionId])
}

// Prescription Notes
model PrescriptionNote {
  id                  String    @id @default(cuid())
  prescriptionId      String

  noteType            PrescriptionNoteType @default(GENERAL)
  content             String    @db.Text

  // For DUR overrides
  durCode             String?
  overrideReason      String?

  // Priority flag
  isPriority          Boolean   @default(false)
  isInternal          Boolean   @default(true)  // vs patient-visible

  createdById         String?
  createdAt           DateTime  @default(now())

  prescription        Prescription @relation(fields: [prescriptionId], references: [id])
  createdBy           PharmacyStaff? @relation("NotesCreated", fields: [createdById], references: [id])

  @@index([prescriptionId])
  @@index([noteType])
  @@index([createdAt])
}

// Prescription State History (Audit Trail)
model PrescriptionStateHistory {
  id                  String    @id @default(cuid())
  prescriptionId      String

  fromState           PrescriptionWorkflowState?
  toState             PrescriptionWorkflowState

  changedById         String?
  changedAt           DateTime  @default(now())

  reason              String?
  notes               String?   @db.Text

  // Snapshot of key data at time of change
  snapshotData        Json?

  prescription        Prescription @relation(fields: [prescriptionId], references: [id])
  changedBy           PharmacyStaff? @relation("StateChanges", fields: [changedById], references: [id])

  @@index([prescriptionId])
  @@index([changedAt])
  @@index([toState])
}

// DUR Alerts for Prescriptions
model PrescriptionDURAlert {
  id                  String    @id @default(cuid())
  prescriptionId      String

  // Alert Details
  alertType           String    // drug_interaction, allergy, dosing, etc.
  severity            String    // high, moderate, low
  code                String
  message             String    @db.Text
  recommendation      String?   @db.Text

  // Related Drug (if drug-drug interaction)
  interactingDrugName String?
  interactingNdc      String?

  // Override Info
  isOverridden        Boolean   @default(false)
  overriddenById      String?
  overriddenAt        DateTime?
  overrideReason      String?
  overrideCode        String?   // Professional service code

  // Status
  isAcknowledged      Boolean   @default(false)
  acknowledgedById    String?
  acknowledgedAt      DateTime?

  createdAt           DateTime  @default(now())

  prescription        Prescription @relation(fields: [prescriptionId], references: [id])
  overriddenBy        PharmacyStaff? @relation("DUROverrides", fields: [overriddenById], references: [id])
  acknowledgedBy      PharmacyStaff? @relation("DURAcknowledged", fields: [acknowledgedById], references: [id])

  @@index([prescriptionId])
  @@index([alertType])
  @@index([severity])
  @@index([isOverridden])
}

// Pickup Session (group multiple Rx for one pickup event)
model PickupSession {
  id                  String    @id @default(cuid())

  // Patient
  patientId           String

  // Session Type
  sessionType         PickupSessionType @default(RETAIL)
  status              PickupSessionStatus @default(IN_PROGRESS)

  // Patient Verification
  patientVerified     Boolean   @default(false)
  verificationMethod  String?   // DOB, ID, photo

  // ID Verification (for controlled substances)
  idVerified          Boolean   @default(false)
  idType              IDVerificationType?
  idNumber            String?   // Last 4 only
  idState             String?
  idExpiration        DateTime?

  // Signature
  signatureCaptured   Boolean   @default(false)
  signatureData       String?   @db.LongText  // Base64 encoded
  signatureTimestamp  DateTime?
  signatureReason     String?   // pickup, counseling_waiver, hipaa, controlled

  // Counseling
  counselingOffered   Boolean   @default(false)
  counselingAccepted  Boolean   @default(false)
  counselingWaived    Boolean   @default(false)
  counselingNotes     String?   @db.Text

  // Payment
  totalAmount         Float     @default(0)
  amountPaid          Float     @default(0)
  paymentMethod       String?
  paymentReference    String?

  // Staff
  startedById         String?
  completedById       String?

  // Timestamps
  startedAt           DateTime  @default(now())
  completedAt         DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  patient             Patient   @relation(fields: [patientId], references: [id])
  startedBy           PharmacyStaff? @relation("PickupsStarted", fields: [startedById], references: [id])
  completedBy         PharmacyStaff? @relation("PickupsCompleted", fields: [completedById], references: [id])
  fills               PrescriptionFill[]

  @@index([patientId])
  @@index([status])
  @@index([startedAt])
}
